"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reporterProxy = require("../reporter-proxy");

var _eventKit = require("event-kit");

var _commitDetailItem = _interopRequireDefault(require("../items/commit-detail-item"));

var _uriPattern = _interopRequireDefault(require("../atom/uri-pattern"));

var _recentCommitsView = _interopRequireDefault(require("../views/recent-commits-view"));

var _refHolder = _interopRequireDefault(require("../models/ref-holder"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class RecentCommitsController extends _react.default.Component {
  constructor(props, context) {
    super(props, context);

    _defineProperty(this, "updateSelectedCommit", () => {
      const activeItem = this.props.workspace.getActivePaneItem();
      const pattern = new _uriPattern.default(decodeURIComponent(_commitDetailItem.default.buildURI(this.props.repository.getWorkingDirectoryPath(), '{sha}')));

      if (activeItem && activeItem.getURI) {
        const match = pattern.matches(activeItem.getURI());
        const {
          sha
        } = match.getParams();

        if (match.ok() && sha && sha !== this.state.selectedCommitSha) {
          return new Promise(resolve => this.setState({
            selectedCommitSha: sha
          }, resolve));
        }
      }

      return Promise.resolve();
    });

    _defineProperty(this, "openCommit", async ({
      sha,
      preserveFocus
    }) => {
      const workdir = this.props.repository.getWorkingDirectoryPath();

      const uri = _commitDetailItem.default.buildURI(workdir, sha);

      const item = await this.props.workspace.open(uri, {
        pending: true
      });

      if (preserveFocus) {
        item.preventFocus();
        this.setFocus(this.constructor.focus.RECENT_COMMIT);
      }

      (0, _reporterProxy.addEvent)('open-commit-in-pane', {
        package: 'github',
        from: this.constructor.name
      });
    });

    _defineProperty(this, "selectNextCommit", () => this.setSelectedCommitIndex(this.getSelectedCommitIndex() + 1));

    _defineProperty(this, "selectPreviousCommit", () => this.setSelectedCommitIndex(Math.max(this.getSelectedCommitIndex() - 1, 0)));

    this.subscriptions = new _eventKit.CompositeDisposable(this.props.workspace.onDidChangeActivePaneItem(this.updateSelectedCommit));
    this.refView = new _refHolder.default();
    this.state = {
      selectedCommitSha: ''
    };
  }

  render() {
    return /*#__PURE__*/_react.default.createElement(_recentCommitsView.default, {
      ref: this.refView.setter,
      commits: this.props.commits,
      isLoading: this.props.isLoading,
      undoLastCommit: this.props.undoLastCommit,
      openCommit: this.openCommit,
      selectNextCommit: this.selectNextCommit,
      selectPreviousCommit: this.selectPreviousCommit,
      selectedCommitSha: this.state.selectedCommitSha,
      commands: this.props.commands,
      clipboard: atom.clipboard
    });
  }

  getSelectedCommitIndex() {
    return this.props.commits.findIndex(commit => commit.getSha() === this.state.selectedCommitSha);
  }

  setSelectedCommitIndex(ind) {
    const commit = this.props.commits[ind];

    if (commit) {
      return new Promise(resolve => this.setState({
        selectedCommitSha: commit.getSha()
      }, resolve));
    } else {
      return Promise.resolve();
    }
  }

  getFocus(element) {
    return this.refView.map(view => view.getFocus(element)).getOr(null);
  }

  setFocus(focus) {
    return this.refView.map(view => {
      const wasFocused = view.setFocus(focus);

      if (wasFocused && this.getSelectedCommitIndex() === -1) {
        this.setSelectedCommitIndex(0);
      }

      return wasFocused;
    }).getOr(false);
  }

  advanceFocusFrom(focus) {
    return this.refView.map(view => view.advanceFocusFrom(focus)).getOr(Promise.resolve(null));
  }

  retreatFocusFrom(focus) {
    return this.refView.map(view => view.retreatFocusFrom(focus)).getOr(Promise.resolve(null));
  }

}

exports.default = RecentCommitsController;

_defineProperty(RecentCommitsController, "propTypes", {
  commits: _propTypes.default.arrayOf(_propTypes.default.object).isRequired,
  isLoading: _propTypes.default.bool.isRequired,
  undoLastCommit: _propTypes.default.func.isRequired,
  workspace: _propTypes.default.object.isRequired,
  repository: _propTypes.default.object.isRequired,
  commands: _propTypes.default.object.isRequired
});

_defineProperty(RecentCommitsController, "focus", _recentCommitsView.default.focus);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb250cm9sbGVycy9yZWNlbnQtY29tbWl0cy1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIlJlY2VudENvbW1pdHNDb250cm9sbGVyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiY29udGV4dCIsImFjdGl2ZUl0ZW0iLCJ3b3Jrc3BhY2UiLCJnZXRBY3RpdmVQYW5lSXRlbSIsInBhdHRlcm4iLCJVUklQYXR0ZXJuIiwiZGVjb2RlVVJJQ29tcG9uZW50IiwiQ29tbWl0RGV0YWlsSXRlbSIsImJ1aWxkVVJJIiwicmVwb3NpdG9yeSIsImdldFdvcmtpbmdEaXJlY3RvcnlQYXRoIiwiZ2V0VVJJIiwibWF0Y2giLCJtYXRjaGVzIiwic2hhIiwiZ2V0UGFyYW1zIiwib2siLCJzdGF0ZSIsInNlbGVjdGVkQ29tbWl0U2hhIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRTdGF0ZSIsInByZXNlcnZlRm9jdXMiLCJ3b3JrZGlyIiwidXJpIiwiaXRlbSIsIm9wZW4iLCJwZW5kaW5nIiwicHJldmVudEZvY3VzIiwic2V0Rm9jdXMiLCJmb2N1cyIsIlJFQ0VOVF9DT01NSVQiLCJwYWNrYWdlIiwiZnJvbSIsIm5hbWUiLCJzZXRTZWxlY3RlZENvbW1pdEluZGV4IiwiZ2V0U2VsZWN0ZWRDb21taXRJbmRleCIsIk1hdGgiLCJtYXgiLCJzdWJzY3JpcHRpb25zIiwiQ29tcG9zaXRlRGlzcG9zYWJsZSIsIm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0iLCJ1cGRhdGVTZWxlY3RlZENvbW1pdCIsInJlZlZpZXciLCJSZWZIb2xkZXIiLCJyZW5kZXIiLCJzZXR0ZXIiLCJjb21taXRzIiwiaXNMb2FkaW5nIiwidW5kb0xhc3RDb21taXQiLCJvcGVuQ29tbWl0Iiwic2VsZWN0TmV4dENvbW1pdCIsInNlbGVjdFByZXZpb3VzQ29tbWl0IiwiY29tbWFuZHMiLCJhdG9tIiwiY2xpcGJvYXJkIiwiZmluZEluZGV4IiwiY29tbWl0IiwiZ2V0U2hhIiwiaW5kIiwiZ2V0Rm9jdXMiLCJlbGVtZW50IiwibWFwIiwidmlldyIsImdldE9yIiwid2FzRm9jdXNlZCIsImFkdmFuY2VGb2N1c0Zyb20iLCJyZXRyZWF0Rm9jdXNGcm9tIiwiUHJvcFR5cGVzIiwiYXJyYXlPZiIsIm9iamVjdCIsImlzUmVxdWlyZWQiLCJib29sIiwiZnVuYyIsIlJlY2VudENvbW1pdHNWaWV3Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVlLE1BQU1BLHVCQUFOLFNBQXNDQyxlQUFNQyxTQUE1QyxDQUFzRDtBQVluRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVFDLE9BQVIsRUFBaUI7QUFDMUIsVUFBTUQsS0FBTixFQUFhQyxPQUFiOztBQUQwQixrREFZTCxNQUFNO0FBQzNCLFlBQU1DLFVBQVUsR0FBRyxLQUFLRixLQUFMLENBQVdHLFNBQVgsQ0FBcUJDLGlCQUFyQixFQUFuQjtBQUVBLFlBQU1DLE9BQU8sR0FBRyxJQUFJQyxtQkFBSixDQUFlQyxrQkFBa0IsQ0FDL0NDLDBCQUFpQkMsUUFBakIsQ0FDRSxLQUFLVCxLQUFMLENBQVdVLFVBQVgsQ0FBc0JDLHVCQUF0QixFQURGLEVBRUUsT0FGRixDQUQrQyxDQUFqQyxDQUFoQjs7QUFNQSxVQUFJVCxVQUFVLElBQUlBLFVBQVUsQ0FBQ1UsTUFBN0IsRUFBcUM7QUFDbkMsY0FBTUMsS0FBSyxHQUFHUixPQUFPLENBQUNTLE9BQVIsQ0FBZ0JaLFVBQVUsQ0FBQ1UsTUFBWCxFQUFoQixDQUFkO0FBQ0EsY0FBTTtBQUFDRyxVQUFBQTtBQUFELFlBQVFGLEtBQUssQ0FBQ0csU0FBTixFQUFkOztBQUNBLFlBQUlILEtBQUssQ0FBQ0ksRUFBTixNQUFjRixHQUFkLElBQXFCQSxHQUFHLEtBQUssS0FBS0csS0FBTCxDQUFXQyxpQkFBNUMsRUFBK0Q7QUFDN0QsaUJBQU8sSUFBSUMsT0FBSixDQUFZQyxPQUFPLElBQUksS0FBS0Ms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bUIsR0FBYixDQUFpQkMsSUFBSSxJQUFJQSxJQUFJLENBQUNJLGdCQUFMLENBQXNCckMsS0FBdEIsQ0FBekIsRUFBdURrQyxLQUF2RCxDQUE2RDdDLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQixJQUFoQixDQUE3RCxDQUFQO0FBQ0Q7O0FBN0drRTs7OztnQkFBaER6Qix1QixlQUNBO0FBQ2pCb0QsRUFBQUEsT0FBTyxFQUFFcUIsbUJBQVVDLE9BQVYsQ0FBa0JELG1CQUFVRSxNQUE1QixFQUFvQ0MsVUFENUI7QUFFakJ2QixFQUFBQSxTQUFTLEVBQUVvQixtQkFBVUksSUFBVixDQUFlRCxVQUZUO0FBR2pCdEIsRUFBQUEsY0FBYyxFQUFFbUIsbUJBQVVLLElBQVYsQ0FBZUYsVUFIZDtBQUlqQnJFLEVBQUFBLFNBQVMsRUFBRWtFLG1CQUFVRSxNQUFWLENBQWlCQyxVQUpYO0FBS2pCOUQsRUFBQUEsVUFBVSxFQUFFMkQsbUJBQVVFLE1BQVYsQ0FBaUJDLFVBTFo7QUFNakJsQixFQUFBQSxRQUFRLEVBQUVlLG1CQUFVRSxNQUFWLENBQWlCQztBQU5WLEM7O2dCQURBNUUsdUIsV0FVSitFLDJCQUFrQjVDLEsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7YWRkRXZlbnR9IGZyb20gJy4uL3JlcG9ydGVyLXByb3h5JztcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnZXZlbnQta2l0JztcblxuaW1wb3J0IENvbW1pdERldGFpbEl0ZW0gZnJvbSAnLi4vaXRlbXMvY29tbWl0LWRldGFpbC1pdGVtJztcbmltcG9ydCBVUklQYXR0ZXJuIGZyb20gJy4uL2F0b20vdXJpLXBhdHRlcm4nO1xuaW1wb3J0IFJlY2VudENvbW1pdHNWaWV3IGZyb20gJy4uL3ZpZXdzL3JlY2VudC1jb21taXRzLXZpZXcnO1xuaW1wb3J0IFJlZkhvbGRlciBmcm9tICcuLi9tb2RlbHMvcmVmLWhvbGRlcic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlY2VudENvbW1pdHNDb250cm9sbGVyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBjb21taXRzOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMub2JqZWN0KS5pc1JlcXVpcmVkLFxuICAgIGlzTG9hZGluZzogUHJvcFR5cGVzLmJvb2wuaXNSZXF1aXJlZCxcbiAgICB1bmRvTGFzdENvbW1pdDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgICB3b3Jrc3BhY2U6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICByZXBvc2l0b3J5OiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgY29tbWFuZHM6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgfVxuXG4gIHN0YXRpYyBmb2N1cyA9IFJlY2VudENvbW1pdHNWaWV3LmZvY3VzXG5cbiAgY29uc3RydWN0b3IocHJvcHMsIGNvbnRleHQpIHtcbiAgICBzdXBlcihwcm9wcywgY29udGV4dCk7XG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZShcbiAgICAgIHRoaXMucHJvcHMud29ya3NwYWNlLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0odGhpcy51cGRhdGVTZWxlY3RlZENvbW1pdCksXG4gICAgKTtcblxuICAgIHRoaXMucmVmVmlldyA9IG5ldyBSZWZIb2xkZXIoKTtcblxuICAgIHRoaXMuc3RhdGUgPSB7c2VsZWN0ZWRDb21taXRTaGE6ICcnfTtcbiAgfVxuXG4gIHVwZGF0ZVNlbGVjdGVkQ29tbWl0ID0gKCkgPT4ge1xuICAgIGNvbnN0IGFjdGl2ZUl0ZW0gPSB0aGlzLnByb3BzLndvcmtzcGFjZS5nZXRBY3RpdmVQYW5lSXRlbSgpO1xuXG4gICAgY29uc3QgcGF0dGVybiA9IG5ldyBVUklQYXR0ZXJuKGRlY29kZVVSSUNvbXBvbmVudChcbiAgICAgIENvbW1pdERldGFpbEl0ZW0uYnVpbGRVUkkoXG4gICAgICAgIHRoaXMucHJvcHMucmVwb3NpdG9yeS5nZXRXb3JraW5nRGlyZWN0b3J5UGF0aCgpLFxuICAgICAgICAne3NoYX0nKSxcbiAgICApKTtcblxuICAgIGlmIChhY3RpdmVJdGVtICYmIGFjdGl2ZUl0ZW0uZ2V0VVJJKSB7XG4gICAgICBjb25zdCBtYXRjaCA9IHBhdHRlcm4ubWF0Y2hlcyhhY3RpdmVJdGVtLmdldFVSSSgpKTtcbiAgICAgIGNvbnN0IHtzaGF9ID0gbWF0Y2guZ2V0UGFyYW1zKCk7XG4gICAgICBpZiAobWF0Y2gub2soKSAmJiBzaGEgJiYgc2hhICE9PSB0aGlzLnN0YXRlLnNlbGVjdGVkQ29tbWl0U2hhKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHRoaXMuc2V0U3RhdGUoe3NlbGVjdGVkQ29tbWl0U2hhOiBzaGF9LCByZXNvbHZlKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gKFxuICAgICAgPFJlY2VudENvbW1pdHNWaWV3XG4gICAgICAgIHJlZj17dGhpcy5yZWZWaWV3LnNldHRlcn1cbiAgICAgICAgY29tbWl0cz17dGhpcy5wcm9wcy5jb21taXRzfVxuICAgICAgICBpc0xvYWRpbmc9e3RoaXMucHJvcHMuaXNMb2FkaW5nfVxuICAgICAgICB1bmRvTGFzdENvbW1pdD17dGhpcy5wcm9wcy51bmRvTGFzdENvbW1pdH1cbiAgICAgICAgb3BlbkNvbW1pdD17dGhpcy5vcGVuQ29tbWl0fVxuICAgICAgICBzZWxlY3ROZXh0Q29tbWl0PXt0aGlzLnNlbGVjdE5leHRDb21taXR9XG4gICAgICAgIHNlbGVjdFByZXZpb3VzQ29tbWl0PXt0aGlzLnNlbGVjdFByZXZpb3VzQ29tbWl0fVxuICAgICAgICBzZWxlY3RlZENvbW1pdFNoYT17dGhpcy5zdGF0ZS5zZWxlY3RlZENvbW1pdFNoYX1cbiAgICAgICAgY29tbWFuZHM9e3RoaXMucHJvcHMuY29tbWFuZHN9XG4gICAgICAgIGNsaXBib2FyZD17YXRvbS5jbGlwYm9hcmR9XG4gICAgICAvPlxuICAgICk7XG4gIH1cblxuICBvcGVuQ29tbWl0ID0gYXN5bmMgKHtzaGEsIHByZXNlcnZlRm9jdXN9KSA9PiB7XG4gICAgY29uc3Qgd29ya2RpciA9IHRoaXMucHJvcHMucmVwb3NpdG9yeS5nZXRXb3JraW5nRGlyZWN0b3J5UGF0aCgpO1xuICAgIGNvbnN0IHVyaSA9IENvbW1pdERldGFpbEl0ZW0uYnVpbGRVUkkod29ya2Rpciwgc2hhKTtcbiAgICBjb25zdCBpdGVtID0gYXdhaXQgdGhpcy5wcm9wcy53b3Jrc3BhY2Uub3Blbih1cmksIHtwZW5kaW5nOiB0cnVlfSk7XG4gICAgaWYgKHByZXNlcnZlRm9jdXMpIHtcbiAgICAgIGl0ZW0ucHJldmVudEZvY3VzKCk7XG4gICAgICB0aGlzLnNldEZvY3VzKHRoaXMuY29uc3RydWN0b3IuZm9jdXMuUkVDRU5UX0NPTU1JVCk7XG4gICAgfVxuICAgIGFkZEV2ZW50KCdvcGVuLWNvbW1pdC1pbi1wYW5lJywge3BhY2thZ2U6ICdnaXRodWInLCBmcm9tOiB0aGlzLmNvbnN0cnVjdG9yLm5hbWV9KTtcbiAgfVxuXG4gIC8vIFdoZW4gbm8gY29tbWl0IGlzIHNlbGVjdGVkLCBgZ2V0U2VsZWN0ZWRDb21taXRJbmRleGAgcmV0dXJucyAtMSAmIHRoZSBjb21taXQgYXQgaW5kZXggMCAoZmlyc3QgY29tbWl0KSBpcyBzZWxlY3RlZFxuICBzZWxlY3ROZXh0Q29tbWl0ID0gKCkgPT4gdGhpcy5zZXRTZWxlY3RlZENvbW1pdEluZGV4KHRoaXMuZ2V0U2VsZWN0ZWRDb21taXRJbmRleCgpICsgMSk7XG5cbiAgc2VsZWN0UHJldmlvdXNDb21taXQgPSAoKSA9PiB0aGlzLnNldFNlbGVjdGVkQ29tbWl0SW5kZXgoTWF0aC5tYXgodGhpcy5nZXRTZWxlY3RlZENvbW1pdEluZGV4KCkgLSAxLCAwKSk7XG5cbiAgZ2V0U2VsZWN0ZWRDb21taXRJbmRleCgpIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5jb21taXRzLmZpbmRJbmRleChjb21taXQgPT4gY29tbWl0LmdldFNoYSgpID09PSB0aGlzLnN0YXRlLnNlbGVjdGVkQ29tbWl0U2hhKTtcbiAgfVxuXG4gIHNldFNlbGVjdGVkQ29tbWl0SW5kZXgoaW5kKSB7XG4gICAgY29uc3QgY29tbWl0ID0gdGhpcy5wcm9wcy5jb21taXRzW2luZF07XG4gICAgaWYgKGNvbW1pdCkge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdGhpcy5zZXRTdGF0ZSh7c2VsZWN0ZWRDb21taXRTaGE6IGNvbW1pdC5nZXRTaGEoKX0sIHJlc29sdmUpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgfVxuXG4gIGdldEZvY3VzKGVsZW1lbnQpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZWaWV3Lm1hcCh2aWV3ID0+IHZpZXcuZ2V0Rm9jdXMoZWxlbWVudCkpLmdldE9yKG51bGwpO1xuICB9XG5cbiAgc2V0Rm9jdXMoZm9jdXMpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZWaWV3Lm1hcCh2aWV3ID0+IHtcbiAgICAgIGNvbnN0IHdhc0ZvY3VzZWQgPSB2aWV3LnNldEZvY3VzKGZvY3VzKTtcbiAgICAgIGlmICh3YXNGb2N1c2VkICYmIHRoaXMuZ2V0U2VsZWN0ZWRDb21taXRJbmRleCgpID09PSAtMSkge1xuICAgICAgICB0aGlzLnNldFNlbGVjdGVkQ29tbWl0SW5kZXgoMCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gd2FzRm9jdXNlZDtcbiAgICB9KS5nZXRPcihmYWxzZSk7XG4gIH1cblxuICBhZHZhbmNlRm9jdXNGcm9tKGZvY3VzKSB7XG4gICAgcmV0dXJuIHRoaXMucmVmVmlldy5tYXAodmlldyA9PiB2aWV3LmFkdmFuY2VGb2N1c0Zyb20oZm9jdXMpKS5nZXRPcihQcm9taXNlLnJlc29sdmUobnVsbCkpO1xuICB9XG5cbiAgcmV0cmVhdEZvY3VzRnJvbShmb2N1cykge1xuICAgIHJldHVybiB0aGlzLnJlZlZpZXcubWFwKHZpZXcgPT4gdmlldy5yZXRyZWF0Rm9jdXNGcm9tKGZvY3VzKSkuZ2V0T3IoUHJvbWlzZS5yZXNvbHZlKG51bGwpKTtcbiAgfVxufVxuIl19