"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _electron = require("electron");

var _helpers = require("../helpers");

var _source = require("../models/conflicts/source");

var _decoration = _interopRequireDefault(require("../atom/decoration"));

var _octicon = _interopRequireDefault(require("../atom/octicon"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const {
  Menu,
  MenuItem
} = _electron.remote;

class ConflictController extends _react.default.Component {
  constructor(props, context) {
    super(props, context);
    (0, _helpers.autobind)(this, 'showResolveMenu');
    this.state = {
      chosenSide: this.props.conflict.getChosenSide()
    };
  }

  resolveAsSequence(sources) {
    this.props.resolveAsSequence(sources);
    this.setState({
      chosenSide: this.props.conflict.getChosenSide()
    });
  }

  revert(side) {
    side.isModified() && side.revert();
    side.isBannerModified() && side.revertBanner();
  }

  showResolveMenu(event) {
    event.preventDefault();
    const menu = new Menu();
    menu.append(new MenuItem({
      label: 'Resolve as Ours',
      click: this.resolveAsSequence.bind(this, [_source.OURS])
    }));

    if (this.props.conflict.getSide(_source.BASE)) {
      menu.append(new MenuItem({
        label: 'Resolve as Base',
        click: this.resolveAsSequence.bind(this, [_source.BASE])
      }));
    }

    menu.append(new MenuItem({
      label: 'Resolve as Theirs',
      click: this.resolveAsSequence.bind(this, [_source.THEIRS])
    }));
    menu.append(new MenuItem({
      type: 'separator'
    }));
    menu.append(new MenuItem({
      label: 'Resolve as Ours Then Theirs',
      click: this.resolveAsSequence.bind(this, [_source.OURS, _source.THEIRS])
    }));
    menu.append(new MenuItem({
      label: 'Resolve as Theirs Then Ours',
      click: this.resolveAsSequence.bind(this, [_source.THEIRS, _source.OURS])
    }));
    menu.append(new MenuItem({
      type: 'separator'
    }));
    menu.append(new MenuItem({
      label: 'Dismiss',
      click: this.props.dismiss
    }));
    menu.popup(_electron.remote.getCurrentWindow());
  }

  render() {
    if (!this.state.chosenSide) {
      const ours = this.props.conflict.getSide(_source.OURS);
      const base = this.props.conflict.getSide(_source.BASE);
      const theirs = this.props.conflict.getSide(_source.THEIRS);
      return /*#__PURE__*/_react.default.createElement("div", null, this.renderSide(ours), base && this.renderSide(base), /*#__PURE__*/_react.default.createElement(_decoration.default, {
        key: this.props.conflict.getSeparator().getMarker().id,
        editor: this.props.editor,
        decorable: this.props.conflict.getSeparator().getMarker(),
        type: "line",
        className: "github-ConflictSeparator"
      }), this.renderSide(theirs));
    } else if (!this.state.chosenSide.isEmpty()) {
      return /*#__PURE__*/_react.default.createElement(_decoration.default, {
        editor: this.props.editor,
        decorable: this.state.chosenSide.getMarker(),
        type: "line",
        className: "github-ResolvedLines"
      });
    } else {
      return null;
    }
  }

  renderSide(side) {
    const source = side.getSource();
    return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement(_decoration.default, {
      key: side.banner.marker.id,
      editor: this.props.editor,
      decorable: side.getBannerMarker(),
      type: "line",
      className: side.getBannerCSSClass()
    }), side.isBannerModified() || /*#__PURE__*/_react.default.createElement(_decoration.default, {
      key: 'banner-modified-' + side.banner.marker.id,
      editor: this.props.editor,
      decorable: side.getBannerMarker(),
      type: "line",
      className: "github-ConflictUnmodifiedBanner"
    }), /*#__PURE__*/_react.default.createElement(_decoration.default, {
      key: side.marker.id,
      editor: this.props.editor,
      decorable: side.getMarker(),
      type: "line",
      className: side.getLineCSSClass()
    }), /*#__PURE__*/_react.default.createElement(_decoration.default, {
      key: 'block-' + side.marker.id,
      editor: this.props.editor,
      decorable: side.getBlockMarker(),
      type: "block",
      position: side.getBlockPosition()
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: side.getBlockCSSClasses()
    }, /*#__PURE__*/_react.default.createElement("span", {
      className: "github-ResolutionControls"
    }, /*#__PURE__*/_react.default.createElement("button", {
      className: "btn btn-sm inline-block",
      onClick: () => this.resolveAsSequence([source])
    }, "Use me"), (side.isModified() || side.isBannerModified()) && /*#__PURE__*/_react.default.createElement("button", {
      className: "btn btn-sm inline-block",
      onClick: () => this.revert(side)
    }, "Revert"), /*#__PURE__*/_react.default.createElement(_octicon.default, {
      icon: "ellipses",
      className: "inline-block",
      onClick: this.showResolveMenu
    })), /*#__PURE__*/_react.default.createElement("span", {
      className: "github-SideDescription"
    }, source.toUIString()))));
  }

}

exports.default = ConflictController;

_defineProperty(ConflictController, "propTypes", {
  editor: _propTypes.default.object.isRequired,
  conflict: _propTypes.default.object.isRequired,
  resolveAsSequence: _propTypes.default.func,
  dismiss: _propTypes.default.func
});

_defineProperty(ConflictController, "defaultProps", {
  resolveAsSequence: sources => {},
  dismiss: () => {}
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb250cm9sbGVycy9jb25mbGljdC1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIk1lbnUiLCJNZW51SXRlbSIsInJlbW90ZSIsIkNvbmZsaWN0Q29udHJvbGxlciIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImNvbnRleHQiLCJzdGF0ZSIsImNob3NlblNpZGUiLCJjb25mbGljdCIsImdldENob3NlblNpZGUiLCJyZXNvbHZlQXNTZXF1ZW5jZSIsInNvdXJjZXMiLCJzZXRTdGF0ZSIsInJldmVydCIsInNpZGUiLCJpc01vZGlmaWVkIiwiaXNCYW5uZXJNb2RpZmllZCIsInJldmVydEJhbm5lciIsInNob3dSZXNvbHZlTWVudSIsImV2ZW50IiwicHJldmVudERlZmF1bHQiLCJtZW51IiwiYXBwZW5kIiwibGFiZWwiLCJjbGljayIsImJpbmQiLCJPVVJTIiwiZ2V0U2lkZSIsIkJBU0UiLCJUSEVJUlMiLCJ0eXBlIiwiZGlzbWlzcyIsInBvcHVwIiwiZ2V0Q3VycmVudFdpbmRvdyIsInJlbmRlciIsIm91cnMiLCJiYXNlIiwidGhlaXJzIiwicmVuZGVyU2lkZSIsImdldFNlcGFyYXRvciIsImdldE1hcmtlciIsImlkIiwiZWRpdG9yIiwiaXNFbXB0eSIsInNvdXJjZSIsImdldFNvdXJjZSIsImJhbm5lciIsIm1hcmtlciIsImdldEJhbm5lck1hcmtlciIsImdldEJhbm5lckNTU0NsYXNzIiwiZ2V0TGluZUNTU0NsYXNzIiwiZ2V0QmxvY2tNYXJrZXIiLCJnZXRCbG9ja1Bvc2l0aW9uIiwiZ2V0QmxvY2tDU1NDbGFzc2VzIiwidG9VSVN0cmluZyIsIlByb3BUeXBlcyIsIm9iamVjdCIsImlzUmVxdWlyZWQiLCJmdW5jIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUxBLE1BQU07QUFBQ0EsRUFBQUEsSUFBRDtBQUFPQyxFQUFBQTtBQUFQLElBQW1CQyxnQkFBekI7O0FBT2UsTUFBTUMsa0JBQU4sU0FBaUNDLGVBQU1DLFNBQXZDLENBQWlEO0FBYTlEQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUUMsT0FBUixFQUFpQjtBQUMxQixVQUFNRCxLQUFOLEVBQWFDLE9BQWI7QUFDQSwyQkFBUyxJQUFULEVBQWUsaUJBQWY7QUFFQSxTQUFLQyxLQUFMLEdBQWE7QUFDWEMsTUFBQUEsVUFBVSxFQUFFLEtBQUtILEtBQUwsQ0FBV0ksUUFBWCxDQUFvQkMsYUFBcEI7QUFERCxLQUFiO0FBR0Q7O0FBRURDLEVBQUFBLGlCQUFpQixDQUFDQyxPQUFELEVBQVU7QUFDekIsU0FBS1AsS0FBTCxDQUFXTSxpQkFBWCxDQUE2QkMsT0FBN0I7QUFFQSxTQUFLQyxRQUFMLENBQWM7QUFDWkwsTUFBQUEsVUFBVSxFQUFFLEtBQUtILEtBQUwsQ0FBV0ksUUFBWCxDQUFvQkMsYUFBcEI7QUFEQSxLQUFkO0FBR0Q7O0FBRURJLEVBQUFBLE1BQU0sQ0FBQ0MsSUFBRCxFQUFPO0FBQ1hBLElBQUFBLElBQUksQ0FBQ0MsVUFBTCxNQUFxQkQsSUFBSSxDQUFDRCxNQUFMLEVBQXJCO0FBQ0FDLElBQUFBLElBQUksQ0FBQ0UsZ0JBQUwsTUFBMkJGLElBQUksQ0FBQ0csWUFBTCxFQUEzQjtBQUNEOztBQUVEQyxFQUFBQSxlQUFlLENBQUNDLEtBQUQsRUFBUTtBQUNyQkEsSUFBQUEsS0FBSyxDQUFDQyxjQUFOO0FBRUEsVUFBTUMsSUFBSSxHQUFHLElBQUl4QixJQUFKLEVBQWI7QUFFQXdCLElBQUFBLElBQUksQ0FBQ0MsTUFBTCxDQUFZLElBQUl4QixRQUFKLENBQWE7QUFDdkJ5QixNQUFBQSxLQUFLLEVBQUUsaUJBRGdCO0FBRXZCQyxNQUFBQSxLQUFLLEVBQUUsS0FBS2QsaUJBQUwsQ0FBdUJlLElBQXZCLENBQTRCLElBQTVCLEVBQWtDLENBQUNDLFlBQUQsQ0FBbEM7QUFGZ0IsS0FBYixDQUFaOztBQUtBLFFBQUksS0FBS3RCLEtBQUwsQ0FBV0ksUUFBWCxDQUFvQm1CLE9BQXBCLENBQTRCQyxZQUE1QixDQUFKLEVBQXVDO0FBQ3JDUCxNQUFBQSxJQUFJLENBQUNDLE1BQUwsQ0FBWSxJQUFJeEIsUUFBSixDQUFhO0FBQ3ZCeUIsUUFBQUEsS0FBSyxFQUFFLGlCQURnQjtBQUV2QkMsUUFBQUEsS0FBSyxFQUFFLEtBQUtkLGlCQUFMLENBQXVCZSxJQUF2QixDQUE0QixJQUE1QixFQUFrQyxDQUFDRyxZQUFELENBQWxDO0FBRmdCLE9BQWIsQ0FBWjtBQUlEOztBQUVEUCxJQUFBQSxJQUFJLENBQUNDLE1BQUwsQ0FBWSxJQUFJeEIsUUFBSixDQUFhO0FBQ3ZCeUIsTUFBQUEsS0FBSyxFQUFFLG1CQURnQjtBQUV2QkMsTUFBQUEsS0FBSyxFQUFFLEtBQUtkLGlCQUFMLENBQXVCZSxJQUF2QixDQUE0QixJQUE1QixFQUFrQyxDQUFDSSxjQUFELENBQWxDO0FBRmdCLEtBQWIsQ0FBWjtBQUtBUixJQUFBQSxJQUFJLENBQUNDLE1BQUwsQ0FBWSxJQUFJeEIsUUFBSixDQUFhO0FBQUNnQyxNQUFBQSxJQUFJLEVBQUU7QUFBUCxLQUFiLENBQVo7QUFFQVQsSUFBQUEsSUFBSSxDQUFDQyxNQUFMLENBQVksSUFBSXhCLFFBQUosQ0FBYTtBQUN2QnlCLE1BQUFBLEtBQUssRUFBRSw2QkFEZ0I7QUFFdkJDLE1BQUFBLEtBQUssRUFBRSxLQUFLZCxpQkFBTCxDQUF1QmUsSUFBdkIsQ0FBNEIsSUFBNUIsRUFBa0MsQ0FBQ0MsWUFBRCxFQUFPRyxjQUFQLENBQWxDO0FBRmdCLEtBQWIsQ0FBWjtBQUlBUixJQUFBQSxJQUFJLENBQUNDLE1BQUwsQ0FBWSxJQUFJeEIsUUFBSixDQUFhO0FBQ3ZCeUIsTUFBQUEsS0FBSyxFQUFFLDZCQURnQjtBQUV2QkMsTUFBQUEsS0FBSyxFQUFFLEtBQUtkLGlCQUFMLENBQXVCZSxJQUF2QixDQUE0QixJQUE1QixFQUFrQyxDQUFDSSxjQUFELEVBQVNILFlBQVQsQ0FBbEM7QUFGZ0IsS0FBYixDQUFaO0FBS0FMLElBQUFBLElBQUksQ0FBQ0MsTUFBTCxDQUFZLElBQUl4QixRQUFKLENBQWE7QUFBQ2dDLE1BQUFBLElBQUksRUFBRTtBQUFQLEtBQWIsQ0FBWjtBQUVBVCxJQUFBQSxJQUFJLENBQUNDLE1BQUwsQ0FBWSxJQUFJeEIsUUFBSixDQUFhO0FBQ3ZCeUIsTUFBQUEsS0FBSyxFQUFFLFNBRGdCO0FBRXZCQyxNQUFBQSxLQUFLLEVBQUUsS0FBS3BCLEtBQUwsQ0FBVzJCO0FBRkssS0FBYixDQUFaO0FBS0FWLElBQUFBLElBQUksQ0FBQ1csS0FBTCxDQUFXakMsaUJBQU9rQyxnQkFBUCxFQUFYO0FBQ0Q7O0FBRURDLEVBQUFBLE1BQU0sR0FBRztBQUNQLFFBQUksQ0FBQyxLQUFLNUIsS0FBTCxDQUFXQyxVQUFoQixFQUE0QjtBQUMxQixZQUFNNEIsSUFBSSxHQUFHLEtBQUsvQixLQUFMLENBQVdJLFFBQVgsQ0FBb0JtQixPQUFwQixDQUE0QkQsWUFBNUIsQ0FBYjtBQUNBLFlBQU1VLElBQUksR0FBRyxLQUFLaEMsS0FBTCxDQUFXSSxRQUFYLENBQW9CbUIsT0FBcEIsQ0FBNEJDLFlBQTVCLENBQWI7QUFDQSxZQUFNUyxNQUFNLEdBQUcsS0FBS2pDLEtBQUwsQ0FBV0ksUUFBWCxDQUFvQm1CLE9BQXBCLENBQTRCRSxjQUE1QixDQUFmO0FBRUEsMEJBQ0UsMENBQ0csS0FBS1MsVUFBTCxDQUFnQkgsSUFBaEIsQ0FESCxFQUVHQyxJQUFJLElBQUksS0FBS0UsVUFBTCxDQUFnQkYsSUFBaEIsQ0FGWCxlQUdFLDZCQUFDLG1CQUFEO0FBQ0UsUUFBQSxHQUFHLEVBQUUsS0FBS2hDLEtBQUwsQ0FBV0ksUUFBWCxDQUFvQitCLFlBQXBCLEdBQW1DQyxTQUFuQyxHQUErQ0MsRUFEdEQ7QUFFRSxRQUFBLE1BQU0sRUFBRSxLQUFLckMsS0FBTCxDQUFXc0MsTUFGckI7QUFHRSxRQUFBLFNBQVMsRUFBRSxLQUFLdEMsS0FBTCxDQUFXSSxRQUFYLENBQW9CK0IsWUFBcEIsR0FBbUNDLFNBQW5DLEVBSGI7QUFJRSxRQUFBLElBQUksRUFBQyxNQUpQO0FBS0UsUUFBQSxTQUFTLEVBQUM7QUFMWixRQUhGLEVBVUcsS0FBS0YsVUFBTCxDQUFnQkQsTUFBaEIsQ0FWSCxDQURGO0FBY0QsS0FuQkQsTUFtQk8sSUFBSSxDQUFDLEtBQUsvQixLQUFMLENBQVdDLFVBQVgsQ0FBc0JvQyxPQUF0QixFQUFMLEVBQXNDO0FBQzNDLDBCQUNFLDZCQUFDLG1CQUFEO0FBQ0UsUUFBQSxNQUFNLEVBQUUsS0FBS3ZDLEtBQUwsQ0FBV3NDLE1BRHJCO0FBRUUsUUFBQSxTQUFTLEVBQUUsS0FBS3BDLEtBQUwsQ0FBV0MsVUFBWCxDQUFzQmlDLFNBQXRCLEVBRmI7QUFHRSxRQUFBLElBQUksRUFBQyxNQUhQO0FBSUUsUUFBQSxTQUFTLEVBQUM7QUFKWixRQURGO0FBUUQsS0FUTSxNQVNBO0FBQ0wsYUFBTyxJQUFQO0FBQ0Q7QUFDRjs7QUFFREYsRUFBQUEsVUFBVSxDQUFDeEIsSUFBRCxFQUFPO0FBQ2YsVUFBTThCLE1BQU0sR0FBRzlCLElBQUksQ0FBQytCLFNBQUwsRUFBZjtBQUVBLHdCQUNFLHVEQUNFLDZCQUFDLG1CQUFEO0FBQ0UsTUFBQSxHQUFHLEVBQUUvQixJQUFJLENBQUNnQyxNQUFMLENBQVlDLE1BQVosQ0FBbUJOLEVBRDFCO0FBRUUsTUFBQSxNQUFNLEVBQUUsS0FBS3JDLEtBQUwsQ0FBV3NDLE1BRnJCO0FBR0UsTUFBQSxTQUFTLEVBQUU1QixJQUFJLENBQUNrQyxlQUFMLEVBSGI7QUFJRSxNQUFBLElBQUksRUFBQyxNQUpQO0FBS0UsTUFBQSxTQUFTLEVBQUVsQyxJQUFJLENBQUNtQyxpQkFBTDtBQUxiLE1BREYsRUFRR25DLElBQUksQ0FBQ0UsZ0JBQUwsbUJBQ0MsNkJBQUMsbUJBQUQ7QUFDRSxNQUFBLEdBQUcsRUFBRSxxQkFBcUJGLElBQUksQ0FBQ2dDLE1BQUwsQ0FBWUMsTUFBWixDQUFtQk4sRUFEL0M7QUFFRSxNQUFBLE1BQU0sRUFBRSxLQUFLckMsS0FBTCxDQUFXc0MsTUFGckI7QUFHRSxNQUFBLFNBQVMsRUFBRTVCLElBQUksQ0FBQ2tDLGVBQUwsRUFIYjtBQUlFLE1BQUEsSUFBSSxFQUFDLE1BSlA7QUFLRSxNQUFBLFNBQVMsRUFBQztBQUxaLE1BVEosZUFpQkUsNkJBQUMsbUJBQUQ7QUFDRSxNQUFBLEdBQUcsRUFBRWxDLElBQUksQ0FBQ2lDLE1BQUwsQ0FBWU4sRUFEbkI7QUFFRSxNQUFBLE1BQU0sRUFBRSxLQUFLckMsS0FBTCxDQUFXc0MsTUFGckI7QUFHRSxNQUFBLFNBQVMsRUFBRTVCLElBQUksQ0FBQzBCLFNBQUwsRUFIYjtBQUlFLE1BQUEsSUFBSSxFQUFDLE1BSlA7QUFLRSxNQUFBLFNBQVMsRUFBRTFCLElBQUksQ0FBQ29DLGVBQUw7QUFMYixNQWpCRixlQXdCRSw2QkFBQyxtQkFBRDtBQUNFLE1BQUEsR0FBRyxFQUFFLFdBQVdwQyxJQUFJLENBQUNpQyxNQUFMLENBQVlOLEVBRDlCO0FBRUUsTUFBQSxNQUFNLEVBQUUsS0FBS3JDLEtBQUwsQ0FBV3NDLE1BRnJCO0FBR0UsTUFBQSxTQUFTLEVBQUU1QixJQUFJLENBQUNxQyxjQUFMLEVBSGI7QUFJRSxNQUFBLElBQUksRUFBQyxPQUpQO0FBS0UsTUFBQSxRQUFRLEVBQUVyQyxJQUFJLENBQUNzQyxnQkFBTDtBQUxaLG9CQU1FO0FBQUssTUFBQSxTQUFTLEVBQUV0QyxJQUFJLENBQUN1QyxrQkFBTDtBQUFoQixvQkFDRTtBQUFNLE1BQUEsU0FBUyxFQUFDO0FBQWhCLG9CQUNFO0FBQVEsTUFBQSxTQUFTLEVBQUMseUJBQWxCO0FBQTRDLE1BQUEsT0FBTyxFQUFFLE1BQU0sS0FBSzNDLGlCQUFMLENBQXVCLENBQUNrQyxNQUFELENBQXZCO0FBQTNELGdCQURGLEVBSUcsQ0FBQzlCLElBQUksQ0FBQ0MsVUFBTCxNQUFxQkQsSUFBSSxDQUFDRSxnQkFBTCxFQUF0QixrQkFDQztBQUFRLE1BQUEsU0FBUyxFQUFDLHlCQUFsQjtBQUE0QyxNQUFBLE9BQU8sRUFBRSxNQUFNLEtBQUtILE1BQUwsQ0FBWUMsSUFBWjtBQUEzRCxnQkFMSixlQVNFLDZCQUFDLGdCQUFEO0FBQVMsTUFBQSxJQUFJLEVBQUMsVUFBZDtBQUF5QixNQUFBLFNBQVMsRUFBQyxjQUFuQztBQUFrRCxNQUFBLE9BQU8sRUFBRSxLQUFLSTtBQUFoRSxNQVRGLENBREYsZUFZRTtBQUFNLE1BQUEsU0FBUyxFQUFDO0FBQWhCLE9BQTBDMEIsTUFBTSxDQUFDVSxVQUFQLEVBQTFDLENBWkYsQ0FORixDQXhCRixDQURGO0FBZ0REOztBQW5LNkQ7Ozs7Z0JBQTNDdEQsa0IsZUFDQTtBQUNqQjBDLEVBQUFBLE1BQU0sRUFBRWEsbUJBQVVDLE1BQVYsQ0FBaUJDLFVBRFI7QUFFakJqRCxFQUFBQSxRQUFRLEVBQUUrQyxtQkFBVUMsTUFBVixDQUFpQkMsVUFGVjtBQUdqQi9DLEVBQUFBLGlCQUFpQixFQUFFNkMsbUJBQVVHLElBSFo7QUFJakIzQixFQUFBQSxPQUFPLEVBQUV3QixtQkFBVUc7QUFKRixDOztnQkFEQTFELGtCLGtCQVFHO0FBQ3BCVSxFQUFBQSxpQkFBaUIsRUFBRUMsT0FBTyxJQUFJLENBQUUsQ0FEWjtBQUVwQm9CLEVBQUFBLE9BQU8sRUFBRSxNQUFNLENBQUU7QUFGRyxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQge3JlbW90ZX0gZnJvbSAnZWxlY3Ryb24nO1xuY29uc3Qge01lbnUsIE1lbnVJdGVtfSA9IHJlbW90ZTtcblxuaW1wb3J0IHthdXRvYmluZH0gZnJvbSAnLi4vaGVscGVycyc7XG5pbXBvcnQge09VUlMsIEJBU0UsIFRIRUlSU30gZnJvbSAnLi4vbW9kZWxzL2NvbmZsaWN0cy9zb3VyY2UnO1xuaW1wb3J0IERlY29yYXRpb24gZnJvbSAnLi4vYXRvbS9kZWNvcmF0aW9uJztcbmltcG9ydCBPY3RpY29uIGZyb20gJy4uL2F0b20vb2N0aWNvbic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbmZsaWN0Q29udHJvbGxlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgZWRpdG9yOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgY29uZmxpY3Q6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICByZXNvbHZlQXNTZXF1ZW5jZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgZGlzbWlzczogUHJvcFR5cGVzLmZ1bmMsXG4gIH07XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICByZXNvbHZlQXNTZXF1ZW5jZTogc291cmNlcyA9PiB7fSxcbiAgICBkaXNtaXNzOiAoKSA9PiB7fSxcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuICAgIGF1dG9iaW5kKHRoaXMsICdzaG93UmVzb2x2ZU1lbnUnKTtcblxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBjaG9zZW5TaWRlOiB0aGlzLnByb3BzLmNvbmZsaWN0LmdldENob3NlblNpZGUoKSxcbiAgICB9O1xuICB9XG5cbiAgcmVzb2x2ZUFzU2VxdWVuY2Uoc291cmNlcykge1xuICAgIHRoaXMucHJvcHMucmVzb2x2ZUFzU2VxdWVuY2Uoc291cmNlcyk7XG5cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGNob3NlblNpZGU6IHRoaXMucHJvcHMuY29uZmxpY3QuZ2V0Q2hvc2VuU2lkZSgpLFxuICAgIH0pO1xuICB9XG5cbiAgcmV2ZXJ0KHNpZGUpIHtcbiAgICBzaWRlLmlzTW9kaWZpZWQoKSAmJiBzaWRlLnJldmVydCgpO1xuICAgIHNpZGUuaXNCYW5uZXJNb2RpZmllZCgpICYmIHNpZGUucmV2ZXJ0QmFubmVyKCk7XG4gIH1cblxuICBzaG93UmVzb2x2ZU1lbnUoZXZlbnQpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgY29uc3QgbWVudSA9IG5ldyBNZW51KCk7XG5cbiAgICBtZW51LmFwcGVuZChuZXcgTWVudUl0ZW0oe1xuICAgICAgbGFiZWw6ICdSZXNvbHZlIGFzIE91cnMnLFxuICAgICAgY2xpY2s6IHRoaXMucmVzb2x2ZUFzU2VxdWVuY2UuYmluZCh0aGlzLCBbT1VSU10pLFxuICAgIH0pKTtcblxuICAgIGlmICh0aGlzLnByb3BzLmNvbmZsaWN0LmdldFNpZGUoQkFTRSkpIHtcbiAgICAgIG1lbnUuYXBwZW5kKG5ldyBNZW51SXRlbSh7XG4gICAgICAgIGxhYmVsOiAnUmVzb2x2ZSBhcyBCYXNlJyxcbiAgICAgICAgY2xpY2s6IHRoaXMucmVzb2x2ZUFzU2VxdWVuY2UuYmluZCh0aGlzLCBbQkFTRV0pLFxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIG1lbnUuYXBwZW5kKG5ldyBNZW51SXRlbSh7XG4gICAgICBsYWJlbDogJ1Jlc29sdmUgYXMgVGhlaXJzJyxcbiAgICAgIGNsaWNrOiB0aGlzLnJlc29sdmVBc1NlcXVlbmNlLmJpbmQodGhpcywgW1RIRUlSU10pLFxuICAgIH0pKTtcblxuICAgIG1lbnUuYXBwZW5kKG5ldyBNZW51SXRlbSh7dHlwZTogJ3NlcGFyYXRvcid9KSk7XG5cbiAgICBtZW51LmFwcGVuZChuZXcgTWVudUl0ZW0oe1xuICAgICAgbGFiZWw6ICdSZXNvbHZlIGFzIE91cnMgVGhlbiBUaGVpcnMnLFxuICAgICAgY2xpY2s6IHRoaXMucmVzb2x2ZUFzU2VxdWVuY2UuYmluZCh0aGlzLCBbT1VSUywgVEhFSVJTXSksXG4gICAgfSkpO1xuICAgIG1lbnUuYXBwZW5kKG5ldyBNZW51SXRlbSh7XG4gICAgICBsYWJlbDogJ1Jlc29sdmUgYXMgVGhlaXJzIFRoZW4gT3VycycsXG4gICAgICBjbGljazogdGhpcy5yZXNvbHZlQXNTZXF1ZW5jZS5iaW5kKHRoaXMsIFtUSEVJUlMsIE9VUlNdKSxcbiAgICB9KSk7XG5cbiAgICBtZW51LmFwcGVuZChuZXcgTWVudUl0ZW0oe3R5cGU6ICdzZXBhcmF0b3InfSkpO1xuXG4gICAgbWVudS5hcHBlbmQobmV3IE1lbnVJdGVtKHtcbiAgICAgIGxhYmVsOiAnRGlzbWlzcycsXG4gICAgICBjbGljazogdGhpcy5wcm9wcy5kaXNtaXNzLFxuICAgIH0pKTtcblxuICAgIG1lbnUucG9wdXAocmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKSk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgaWYgKCF0aGlzLnN0YXRlLmNob3NlblNpZGUpIHtcbiAgICAgIGNvbnN0IG91cnMgPSB0aGlzLnByb3BzLmNvbmZsaWN0LmdldFNpZGUoT1VSUyk7XG4gICAgICBjb25zdCBiYXNlID0gdGhpcy5wcm9wcy5jb25mbGljdC5nZXRTaWRlKEJBU0UpO1xuICAgICAgY29uc3QgdGhlaXJzID0gdGhpcy5wcm9wcy5jb25mbGljdC5nZXRTaWRlKFRIRUlSUyk7XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxkaXY+XG4gICAgICAgICAge3RoaXMucmVuZGVyU2lkZShvdXJzKX1cbiAgICAgICAgICB7YmFzZSAmJiB0aGlzLnJlbmRlclNpZGUoYmFzZSl9XG4gICAgICAgICAgPERlY29yYXRpb25cbiAgICAgICAgICAgIGtleT17dGhpcy5wcm9wcy5jb25mbGljdC5nZXRTZXBhcmF0b3IoKS5nZXRNYXJrZXIoKS5pZH1cbiAgICAgICAgICAgIGVkaXRvcj17dGhpcy5wcm9wcy5lZGl0b3J9XG4gICAgICAgICAgICBkZWNvcmFibGU9e3RoaXMucHJvcHMuY29uZmxpY3QuZ2V0U2VwYXJhdG9yKCkuZ2V0TWFya2VyKCl9XG4gICAgICAgICAgICB0eXBlPVwibGluZVwiXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJnaXRodWItQ29uZmxpY3RTZXBhcmF0b3JcIlxuICAgICAgICAgIC8+XG4gICAgICAgICAge3RoaXMucmVuZGVyU2lkZSh0aGVpcnMpfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICghdGhpcy5zdGF0ZS5jaG9zZW5TaWRlLmlzRW1wdHkoKSkge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPERlY29yYXRpb25cbiAgICAgICAgICBlZGl0b3I9e3RoaXMucHJvcHMuZWRpdG9yfVxuICAgICAgICAgIGRlY29yYWJsZT17dGhpcy5zdGF0ZS5jaG9zZW5TaWRlLmdldE1hcmtlcigpfVxuICAgICAgICAgIHR5cGU9XCJsaW5lXCJcbiAgICAgICAgICBjbGFzc05hbWU9XCJnaXRodWItUmVzb2x2ZWRMaW5lc1wiXG4gICAgICAgIC8+XG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICByZW5kZXJTaWRlKHNpZGUpIHtcbiAgICBjb25zdCBzb3VyY2UgPSBzaWRlLmdldFNvdXJjZSgpO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXY+XG4gICAgICAgIDxEZWNvcmF0aW9uXG4gICAgICAgICAga2V5PXtzaWRlLmJhbm5lci5tYXJrZXIuaWR9XG4gICAgICAgICAgZWRpdG9yPXt0aGlzLnByb3BzLmVkaXRvcn1cbiAgICAgICAgICBkZWNvcmFibGU9e3NpZGUuZ2V0QmFubmVyTWFya2VyKCl9XG4gICAgICAgICAgdHlwZT1cImxpbmVcIlxuICAgICAgICAgIGNsYXNzTmFtZT17c2lkZS5nZXRCYW5uZXJDU1NDbGFzcygpfVxuICAgICAgICAvPlxuICAgICAgICB7c2lkZS5pc0Jhbm5lck1vZGlmaWVkKCkgfHxcbiAgICAgICAgICA8RGVjb3JhdGlvblxuICAgICAgICAgICAga2V5PXsnYmFubmVyLW1vZGlmaWVkLScgKyBzaWRlLmJhbm5lci5tYXJrZXIuaWR9XG4gICAgICAgICAgICBlZGl0b3I9e3RoaXMucHJvcHMuZWRpdG9yfVxuICAgICAgICAgICAgZGVjb3JhYmxlPXtzaWRlLmdldEJhbm5lck1hcmtlcigpfVxuICAgICAgICAgICAgdHlwZT1cImxpbmVcIlxuICAgICAgICAgICAgY2xhc3NOYW1lPVwiZ2l0aHViLUNvbmZsaWN0VW5tb2RpZmllZEJhbm5lclwiXG4gICAgICAgICAgLz5cbiAgICAgICAgfVxuICAgICAgICA8RGVjb3JhdGlvblxuICAgICAgICAgIGtleT17c2lkZS5tYXJrZXIuaWR9XG4gICAgICAgICAgZWRpdG9yPXt0aGlzLnByb3BzLmVkaXRvcn1cbiAgICAgICAgICBkZWNvcmFibGU9e3NpZGUuZ2V0TWFya2VyKCl9XG4gICAgICAgICAgdHlwZT1cImxpbmVcIlxuICAgICAgICAgIGNsYXNzTmFtZT17c2lkZS5nZXRMaW5lQ1NTQ2xhc3MoKX1cbiAgICAgICAgLz5cbiAgICAgICAgPERlY29yYXRpb25cbiAgICAgICAgICBrZXk9eydibG9jay0nICsgc2lkZS5tYXJrZXIuaWR9XG4gICAgICAgICAgZWRpdG9yPXt0aGlzLnByb3BzLmVkaXRvcn1cbiAgICAgICAgICBkZWNvcmFibGU9e3NpZGUuZ2V0QmxvY2tNYXJrZXIoKX1cbiAgICAgICAgICB0eXBlPVwiYmxvY2tcIlxuICAgICAgICAgIHBvc2l0aW9uPXtzaWRlLmdldEJsb2NrUG9zaXRpb24oKX0+XG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9e3NpZGUuZ2V0QmxvY2tDU1NDbGFzc2VzKCl9PlxuICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwiZ2l0aHViLVJlc29sdXRpb25Db250cm9sc1wiPlxuICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzTmFtZT1cImJ0biBidG4tc20gaW5saW5lLWJsb2NrXCIgb25DbGljaz17KCkgPT4gdGhpcy5yZXNvbHZlQXNTZXF1ZW5jZShbc291cmNlXSl9PlxuICAgICAgICAgICAgICAgIFVzZSBtZVxuICAgICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgICAgeyhzaWRlLmlzTW9kaWZpZWQoKSB8fCBzaWRlLmlzQmFubmVyTW9kaWZpZWQoKSkgJiZcbiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzTmFtZT1cImJ0biBidG4tc20gaW5saW5lLWJsb2NrXCIgb25DbGljaz17KCkgPT4gdGhpcy5yZXZlcnQoc2lkZSl9PlxuICAgICAgICAgICAgICAgICAgUmV2ZXJ0XG4gICAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgPE9jdGljb24gaWNvbj1cImVsbGlwc2VzXCIgY2xhc3NOYW1lPVwiaW5saW5lLWJsb2NrXCIgb25DbGljaz17dGhpcy5zaG93UmVzb2x2ZU1lbnV9IC8+XG4gICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJnaXRodWItU2lkZURlc2NyaXB0aW9uXCI+e3NvdXJjZS50b1VJU3RyaW5nKCl9PC9zcGFuPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L0RlY29yYXRpb24+XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9XG59XG4iXX0=